<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#21808d">
    <title>Langue Learning - Apprendre les Langues</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-green-500: rgba(34, 197, 94, 1);

            --font-family-base: "Segoe UI", Roboto, sans-serif;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --space-8: 4px;
            --space-16: 8px;
            --space-20: 12px;
            --radius-base: 8px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family-base);
            background: linear-gradient(135deg, #f5f9f9 0%, #e8f4f5 100%);
            min-height: 100vh;
            color: var(--color-slate-900);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-20);
        }

        .header {
            text-align: center;
            margin-bottom: var(--space-20);
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
        }

        .header h1 {
            margin: 0;
            font-size: 32px;
            color: var(--color-teal-500);
        }

        .controls {
            display: flex;
            gap: var(--space-16);
            flex-wrap: wrap;
            justify-content: center;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .control-group label {
            font-weight: 600;
            font-size: 12px;
            color: var(--color-slate-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select,
        input {
            padding: var(--space-8) var(--space-16);
            border: 2px solid var(--color-gray-200);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            background: var(--color-white);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--color-teal-500);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
        }

        .btn {
            padding: var(--space-8) var(--space-20);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: var(--space-8);
        }

        .btn-primary {
            background: var(--color-teal-500);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-teal-400);
        }

        .btn-secondary {
            background: var(--color-gray-200);
            color: var(--color-slate-900);
        }

        .btn-secondary:hover {
            background: var(--color-gray-300);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-20);
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .btn {
                padding: var(--space-16) var(--space-20);
                /* Larger touch targets */
                width: 100%;
                justify-content: center;
            }
        }

        .card {
            background: var(--color-white);
            border-radius: 12px;
            padding: var(--space-20);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
        }

        .card h2 {
            margin: 0;
            font-size: var(--font-size-xl);
            color: var(--color-slate-900);
        }

        .dialogue-box {
            background: #f0f7f8;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            border-left: 4px solid var(--color-teal-500);
            min-height: 80px;
            display: flex;
            align-items: center;
            font-style: italic;
            color: var(--color-slate-900);
            word-wrap: break-word;
        }

        .dialogue-lang {
            font-size: 12px;
            color: var(--color-slate-500);
            margin-bottom: var(--space-8);
            text-transform: uppercase;
            font-weight: 600;
        }

        .audio-controls {
            display: flex;
            gap: var(--space-8);
            flex-wrap: wrap;
        }

        .btn-icon {
            padding: var(--space-8) var(--space-16);
            font-size: 20px;
        }

        .recorder {
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
        }

        .recorder-status {
            text-align: center;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            font-weight: 600;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-ready {
            background: #e8f5e9;
            color: var(--color-green-500);
        }

        .status-recording {
            background: #ffe8e8;
            color: var(--color-red-400);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .status-error {
            background: #ffe8e8;
            color: var(--color-red-400);
        }

        .transcript {
            background: #f9f9f9;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            min-height: 60px;
            border: 2px dashed var(--color-gray-200);
            word-wrap: break-word;
        }

        .transcript-empty {
            color: var(--color-gray-300);
            font-style: italic;
        }

        .correction-box {
            background: #f0f7f8;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            border-left: 4px solid var(--color-teal-500);
            min-height: 80px;
            display: flex;
            align-items: center;
        }

        .correction-box.error {
            border-left-color: var(--color-red-400);
            background: #ffe8e8;
        }

        .correction-box.success {
            border-left-color: var(--color-green-500);
            background: #e8f5e9;
        }

        .correction-content {
            font-size: 13px;
            line-height: 1.6;
            color: var(--color-slate-900);
        }

        .correction-content strong {
            color: var(--color-teal-500);
        }

        .correction-box.error strong {
            color: var(--color-red-400);
        }

        .correction-box.success strong {
            color: var(--color-green-500);
        }

        .divider {
            height: 2px;
            background: var(--color-gray-200);
            margin: var(--space-8) 0;
        }

        .loading {
            text-align: center;
            color: var(--color-slate-500);
            font-size: 12px;
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s steps(3, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: ".";
            }

            40% {
                content: "..";
            }

            60%,
            100% {
                content: "...";
            }
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-16);
            background: var(--color-gray-200);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-top: var(--space-16);
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-teal-500);
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-slate-500);
            margin-top: var(--space-8);
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üó£Ô∏è Langue Learning</h1>

            <div class="controls">
                <div class="control-group">
                    <label>Langue cible</label>
                    <select id="targetLang">
                        <option value="el-GR">Grec (ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨)</option>
                        <option value="es-ES">Espagnol (Espa√±ol)</option>
                        <option value="de-DE">Allemand (Deutsch)</option>
                        <option value="it-IT">Italien (Italiano)</option>
                        <option value="pt-PT">Portugais (Portugu√™s)</option>
                        <option value="ja-JP">Japonais (Êó•Êú¨Ë™û)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Niveau</label>
                    <select id="level">
                        <option value="A1">D√©butant A1</option>
                        <option value="A2">√âl√©mentaire A2</option>
                        <option value="B1">Interm√©diaire B1</option>
                        <option value="B2">Bon B2</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Sujet</label>
                    <select id="topic">
                        <option value="presentation">Pr√©sentation</option>
                        <option value="magasin">Au magasin</option>
                        <option value="dentiste">Chez le dentiste</option>
                        <option value="banque">Banque d'investissement</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="generateBtn">
                    ‚ú® G√©n√©rer Dialogue
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Panneau gauche: Dialogue -->
            <div class="card">
                <h2>üìö Dialogue</h2>

                <div>
                    <div class="dialogue-lang">Fran√ßais (Texte)</div>
                    <div class="dialogue-box" id="frenchDialogue">
                        Cliquez sur "G√©n√©rer Dialogue" pour commencer
                    </div>
                </div>

                <div class="divider"></div>

                <div>
                    <div class="dialogue-lang" id="targetLangLabel">Grec (√Ä r√©p√©ter)</div>
                    <div class="dialogue-box" id="targetDialogue">
                        En attente de g√©n√©ration...
                    </div>
                    <div class="audio-controls">
                        <button class="btn btn-secondary" id="speakTarget" style="flex: 1;">
                            üîä √âcouter le Grec
                        </button>
                        <button class="btn btn-secondary" id="toggleTranslation">
                            üëÅÔ∏è Masquer
                        </button>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">Correctes</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">Totales</div>
                    </div>
                </div>
            </div>

            <!-- Panneau droit: Enregistrement et Correction -->
            <div class="card">
                <h2>üé§ Enregistrement & Correction</h2>

                <div class="recorder">
                    <div class="recorder-status status-ready" id="recorderStatus">
                        Pr√™t √† enregistrer
                    </div>

                    <div style="display: flex; gap: var(--space-8); flex-wrap: wrap;">
                        <button class="btn btn-primary" id="recordBtn" style="flex: 1;">
                            ‚è∫Ô∏è Enregistrer
                        </button>
                        <button class="btn btn-secondary" id="stopBtn" disabled style="flex: 1;">
                            ‚èπÔ∏è Arr√™ter
                        </button>
                    </div>

                    <div class="divider"></div>

                    <div>
                        <div style="font-weight: 600; margin-bottom: var(--space-8);">Votre r√©ponse:</div>
                        <div class="transcript" id="transcript">
                            <span class="transcript-empty">Aucun enregistrement</span>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="checkBtn" style="width: 100%; display: none;" disabled>
                        ‚úÖ V√©rifier la R√©ponse
                    </button>

                    <div class="divider" style="display: none;" id="correctionDivider"></div>

                    <div id="correctionContainer" style="display: none;">
                        <div style="font-weight: 600; margin-bottom: var(--space-8);">Correction:</div>
                        <div class="correction-box" id="correctionBox">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const DIALOGUES = {
            presentation: {
                A1: {
                    fr: ["Bonjour, comment allez-vous?", "Je m'appelle Marie. Et vous?", "O√π habitez-vous?", "Vous venez d'o√π?", "Que faites-vous dans la vie?"],
                    'el-GR': ["ŒöŒ±ŒªŒ∑ŒºŒ≠œÅŒ±, œÄœéœÇ ŒµŒØœÉœÑŒµ;", "ŒúŒµ ŒªŒ≠ŒΩŒµ ŒúŒ±œÅŒØŒ±. ŒïœÉŒ¨œÇ;", "Œ†Œøœç ŒºŒ≠ŒΩŒµœÑŒµ;", "ŒëœÄœå œÄŒøœç Œ≠œÅœáŒµœÉœÑŒµ;", "Œ§Œπ Œ∫Œ¨ŒΩŒµœÑŒµ œÉœÑŒ∑ Œ∂œâŒÆ;"],
                    'es-ES': ["Hola, ¬øc√≥mo est√°s?", "Me llamo Mar√≠a. ¬øY t√∫?", "¬øD√≥nde vives?", "¬øDe d√≥nde vienes?", "¬øA qu√© te dedicas?"],
                    'de-DE': ["Hallo, wie geht es Ihnen?", "Ich hei√üe Maria. Und Sie?", "Wo wohnen Sie?", "Woher kommen Sie?", "Was machen Sie beruflich?"],
                    'it-IT': ["Buongiorno, come sta?", "Mi chiamo Maria. E lei?", "Dove abita?", "Da dove viene?", "Che lavoro fa?"],
                    'pt-PT': ["Ol√°, como est√°?", "Chamo-me Maria. E voc√™?", "Onde mora?", "De onde vem?", "O que faz na vida?"],
                    'ja-JP': ["„Åì„Çì„Å´„Å°„ÅØ„ÄÅÂÖÉÊ∞ó„Åß„Åô„ÅãÔºü", "ÁßÅ„ÅØ„Éû„É™„Ç¢„Åß„Åô„ÄÇ„ÅÇ„Å™„Åü„ÅØÔºü", "„Å©„Åì„Å´‰Ωè„Çì„Åß„ÅÑ„Åæ„Åô„ÅãÔºü", "„Å©„Åì„Åã„ÇâÊù•„Åæ„Åó„Åü„ÅãÔºü", "„Åä‰ªï‰∫ã„ÅØ‰Ωï„Åß„Åô„ÅãÔºü"]
                },
                A2: {
                    fr: ["Parlez-vous d'autres langues?", "Je viens de Paris. C'est une belle ville.", "Pourquoi apprenez-vous cette langue?", "Quel est votre sport pr√©f√©r√©?", "Avez-vous des fr√®res et s≈ìurs?"],
                    'el-GR': ["ŒúŒπŒªŒ¨œÑŒµ Œ¨ŒªŒªŒµœÇ Œ≥ŒªœéœÉœÉŒµœÇ;", "ŒàœÅœáŒøŒºŒ±Œπ Œ±œÄœå œÑŒø Œ†Œ±œÅŒØœÉŒπ. ŒïŒØŒΩŒ±Œπ ŒºŒπŒ± œåŒºŒøœÅœÜŒ∑ œÄœåŒªŒ∑.", "ŒìŒπŒ±œÑŒØ ŒºŒ±Œ∏Œ±ŒØŒΩŒµœÑŒµ Œ±œÖœÑŒÆ œÑŒ∑ Œ≥ŒªœéœÉœÉŒ±;", "Œ†ŒøŒπŒø ŒµŒØŒΩŒ±Œπ œÑŒø Œ±Œ≥Œ±œÄŒ∑ŒºŒ≠ŒΩŒø œÉŒ±œÇ Œ¨Œ∏ŒªŒ∑ŒºŒ±;", "ŒàœáŒµœÑŒµ Œ±Œ¥Œ≠œÅœÜŒπŒ±;"],
                    'es-ES': ["¬øHablas otros idiomas?", "Vengo de Par√≠s. Es una ciudad hermosa.", "¬øPor qu√© est√°s aprendiendo este idioma?", "¬øCu√°l es tu deporte favorito?", "¬øTienes hermanos?"],
                    'de-DE': ["Sprechen Sie andere Sprachen?", "Ich komme aus Paris. Es ist eine sch√∂ne Stadt.", "Warum lernen Sie diese Sprache?", "Was ist Ihr Lieblingssport?", "Haben Sie Geschwister?"],
                    'it-IT': ["Parla altre lingue?", "Vengo da Parigi. √à una bella citt√†.", "Perch√© impara questa lingua?", "Qual √® il suo sport preferito?", "Ha fratelli o sorelle?"],
                    'pt-PT': ["Fala outras l√≠nguas?", "Venho de Paris. √â uma cidade bonita.", "Porque est√° a aprender esta l√≠ngua?", "Qual √© o seu desporto favorito?", "Tem irm√£os?"],
                    'ja-JP': ["‰ªñ„ÅÆË®ÄË™û„ÇíË©±„Åõ„Åæ„Åô„ÅãÔºü", "„Éë„É™„Åã„ÇâÊù•„Åæ„Åó„Åü„ÄÇÁæé„Åó„ÅÑË°ó„Åß„Åô„ÄÇ", "„Å™„Åú„Åì„ÅÆË®ÄË™û„ÇíÂ≠¶„Çì„Åß„ÅÑ„Çã„ÅÆ„Åß„Åô„ÅãÔºü", "Â•Ω„Åç„Å™„Çπ„Éù„Éº„ÉÑ„ÅØ‰Ωï„Åß„Åô„ÅãÔºü", "ÂÖÑÂºü„ÅØ„ÅÑ„Åæ„Åô„ÅãÔºü"]
                },
                B1: {
                    fr: ["Comment envisagez-vous votre avenir professionnel?", "Pensez-vous que l'√©ducation devrait √™tre gratuite?", "Que signifie pour vous r√©ussir dans la vie?"],
                    'el-GR': ["Œ†œéœÇ œÜŒ±ŒΩœÑŒ¨Œ∂ŒµœÉœÑŒµ œÑŒø ŒµœÄŒ±Œ≥Œ≥ŒµŒªŒºŒ±œÑŒπŒ∫œå œÉŒ±œÇ ŒºŒ≠ŒªŒªŒøŒΩ;", "ŒùŒøŒºŒØŒ∂ŒµœÑŒµ œåœÑŒπ Œ∑ ŒµŒ∫œÄŒ±ŒØŒ¥ŒµœÖœÉŒ∑ Œ∏Œ± Œ≠œÄœÅŒµœÄŒµ ŒΩŒ± ŒµŒØŒΩŒ±Œπ Œ¥œâœÅŒµŒ¨ŒΩ;", "Œ§Œπ œÉŒ∑ŒºŒ±ŒØŒΩŒµŒπ Œ≥ŒπŒ± ŒµœÉŒ¨œÇ Œ∑ ŒµœÄŒπœÑœÖœáŒØŒ± œÉœÑŒ∑ Œ∂œâŒÆ;"],
                    'es-ES': ["¬øC√≥mo imagina su futuro profesional?", "¬øCree que la educaci√≥n deber√≠a ser gratuita?", "¬øQu√© significa para usted tener √©xito en la vida?"],
                    'de-DE': ["Wie stellen Sie sich Ihre berufliche Zukunft vor?", "Finden Sie, dass Bildung kostenlos sein sollte?", "Was bedeutet Erfolg im Leben f√ºr Sie?"],
                    'it-IT': ["Come vede il suo futuro professionale?", "Pensa che l'istruzione dovrebbe essere gratuita?", "Cosa significa per lei avere successo nella vita?"],
                    'pt-PT': ["Como imagina o seu futuro profissional?", "Acha que a educa√ß√£o deveria ser gratuite?", "O que significa para si ter sucesso na vida?"],
                    'ja-JP': ["„ÅÇ„Å™„Åü„ÅÆÂ∞ÜÊù•„ÅÆ‰ªï‰∫ã„Å´„Å§„ÅÑ„Å¶„Å©„ÅÜËÄÉ„Åà„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü", "ÊïôËÇ≤„ÅØÁÑ°Êñô„Åß„ÅÇ„Çã„Åπ„Åç„Å†„Å®ÊÄù„ÅÑ„Åæ„Åô„ÅãÔºü", "„ÅÇ„Å™„Åü„Å´„Å®„Å£„Å¶‰∫∫Áîü„ÅÆÊàêÂäü„Å®„ÅØ‰Ωï„Åß„Åô„ÅãÔºü"]
                }
            },
            magasin: {
                A1: {
                    fr: ["Combien √ßa co√ªte?", "Avez-vous ce t-shirt en bleu?", "O√π sont les cabines d'essayage?", "Je cherche du pain.", "C'est trop cher."],
                    'el-GR': ["Œ†œåœÉŒø Œ∫ŒøœÉœÑŒØŒ∂ŒµŒπ;", "ŒàœáŒµœÑŒµ Œ±œÖœÑœå œÑŒø ŒºœÄŒªŒøœÖŒ∂Œ¨Œ∫Œπ œÉŒµ ŒºœÄŒªŒµ;", "Œ†Œøœç ŒµŒØŒΩŒ±Œπ œÑŒ± Œ¥ŒøŒ∫ŒπŒºŒ±œÉœÑŒÆœÅŒπŒ±;", "Œ®Œ¨œáŒΩœâ Œ≥ŒπŒ± œàœâŒºŒØ.", "ŒïŒØŒΩŒ±Œπ œÄŒøŒªœç Œ±Œ∫œÅŒπŒ≤œå."],
                    'es-ES': ["¬øCu√°nto cuesta?", "¬øTiene esta camiseta en azul?", "¬øD√≥nde est√°n los probadores?", "Busco pan.", "Es demasiado caro."],
                    'de-DE': ["Was kostet das?", "Haben Sie dieses T-Shirt in Blau?", "Wo sind die Umkleidekabinen?", "Ich suche Brot.", "Das ist zu teuer."],
                    'it-IT': ["Quanto costa?", "Ha questa maglietta in blu?", "Dove sono i camerini?", "Cerco del pane.", "√à troppo costoso."],
                    'pt-PT': ["Quanto custa?", "Tem esta t-shirt em azul?", "Onde ficam os provadores?", "Procuro p√£o.", "√â muito caro."],
                    'ja-JP': ["„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü", "„Åì„ÅÆT„Ç∑„É£„ÉÑ„ÅÆÈùí„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", "Ë©¶ÁùÄÂÆ§„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü", "„Éë„É≥„ÇíÊé¢„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ", "È´ò„Åô„Åé„Åæ„Åô„ÄÇ"]
                }
            },
            dentiste: {
                A1: {
                    fr: ["J'ai mal aux dents.", "C'est grave?", "Je dois prendre rendez-vous.", "Ouvrez la bouche, s'il vous pla√Æt.", "Rincez-vous la bouche."],
                    'el-GR': ["Œ†ŒøŒΩŒ¨ŒµŒπ œÑŒø Œ¥œåŒΩœÑŒπ ŒºŒøœÖ.", "ŒïŒØŒΩŒ±Œπ œÉŒøŒ≤Œ±œÅœå;", "Œ†œÅŒ≠œÄŒµŒπ ŒΩŒ± Œ∫ŒªŒµŒØœÉœâ œÅŒ±ŒΩœÑŒµŒ≤Œøœç.", "ŒëŒΩŒøŒØŒæœÑŒµ œÑŒø œÉœÑœåŒºŒ± œÉŒ±œÇ, œÄŒ±œÅŒ±Œ∫Œ±Œªœé.", "ŒûŒµœÄŒªœçŒΩŒµœÑŒµ œÑŒø œÉœÑœåŒºŒ± œÉŒ±œÇ."],
                    'es-ES': ["Me duele el diente.", "¬øEs grave?", "Tengo que pedir una cita.", "Abra la boca, por favor.", "Enju√°guese la boca."],
                    'de-DE': ["Ich habe Zahnschmerzen.", "Ist es schlimm?", "Ich muss einen Termin machen.", "√ñffnen Sie bitte den Mund.", "Sp√ºlen Sie Ihren Mund aus."],
                    'it-IT': ["Ho mal di denti.", "√à grave?", "Devo prendere un appuntamento.", "Apra la bocca, per favore.", "Si sciacqui la bocca."],
                    'pt-PT': ["D√≥i-me o dente.", "√â grave?", "Preciso de marcar uma consulta.", "Abra la boca, por favor.", "Enxague a boca."],
                    'ja-JP': ["Ê≠Ø„ÅåÁóõ„ÅÑ„Åß„Åô„ÄÇ", "„Å≤„Å©„ÅÑ„Åß„Åô„ÅãÔºü", "‰∫àÁ¥Ñ„Çí„Åó„Åü„ÅÑ„Åß„Åô„ÄÇ", "Âè£„ÇíÈñã„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "Âè£„Çí„ÇÜ„Åô„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ"]
                }
            },
            banque: {
                A2: {
                    fr: ["Je voudrais ouvrir un compte.", "Quel est le taux d'int√©r√™t?", "Je veux faire un virement.", "Avez-vous des conseils d'investissement?", "O√π est le distributeur?"],
                    'el-GR': ["ŒòŒ± ŒÆŒ∏ŒµŒªŒ± ŒΩŒ± Œ±ŒΩŒøŒØŒæœâ Œ≠ŒΩŒ±ŒΩ ŒªŒøŒ≥Œ±œÅŒπŒ±œÉŒºœå.", "Œ†ŒøŒπŒø ŒµŒØŒΩŒ±Œπ œÑŒø ŒµœÄŒπœÑœåŒ∫ŒπŒø;", "ŒòŒ≠Œªœâ ŒΩŒ± Œ∫Œ¨ŒΩœâ ŒºŒπŒ± ŒºŒµœÑŒ±œÜŒøœÅŒ¨.", "ŒàœáŒµœÑŒµ ŒµœÄŒµŒΩŒ¥œÖœÑŒπŒ∫Œ≠œÇ œÉœÖŒºŒ≤ŒøœÖŒªŒ≠œÇ;", "Œ†Œøœç ŒµŒØŒΩŒ±Œπ œÑŒø ŒëŒ§Œú;"],
                    'es-ES': ["Me gustar√≠a abrir una cuenta.", "¬øCu√°l es la tasa de inter√©s?", "Quiero hacer una transferencia.", "¬øTiene consejos de inversi√≥n?", "¬øD√≥nde est√° el cajero?"],
                    'de-DE': ["Ich m√∂chte ein Konto er√∂ffnen.", "Wie hoch ist der Zinssatz?", "Ich m√∂chte eine √úberweisung machen.", "Haben Sie Anlagetipps?", "Wo ist der Geldautomat?"],
                    'it-IT': ["Vorrei aprire un conto.", "Qual √® il tasso di interesse?", "Voglio fare un bonifico.", "Ha dei consigli di investimento?", "Dov'√® le bancomat?"],
                    'pt-PT': ["Gostaria de abrir uma conta.", "Qual √© a taxa de juro?", "Quero fazer uma transfer√™ncia.", "Tem conselhos de investimento?", "Onde fica o multibanco?"],
                    'ja-JP': ["Âè£Â∫ß„ÇíÈñãË®≠„Åó„Åü„ÅÑ„Åß„Åô„ÄÇ", "Âà©Áéá„ÅØ„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü", "ÊåØËæº„Çí„Åó„Åü„ÅÑ„Åß„Åô„ÄÇ", "ÊäïË≥á„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü", "ATM„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü"]
                }
            }
        };

        // √âtat global
        let state = {
            targetLang: 'el-GR',
            level: 'A1',
            topic: 'presentation',
            currentFrench: '',
            currentTarget: '',
            transcript: '',
            mediaRecorder: null,
            audioChunks: [],
            correctCount: 0,
            totalCount: 0,
            showTranslation: true,
            isRecording: false,
            autoNextTimeout: null
        };

        // √âl√©ments DOM
        const els = {
            targetLangSelect: document.getElementById('targetLang'),
            levelSelect: document.getElementById('level'),
            topicSelect: document.getElementById('topic'),
            generateBtn: document.getElementById('generateBtn'),
            frenchDialogue: document.getElementById('frenchDialogue'),
            targetDialogue: document.getElementById('targetDialogue'),
            targetLangLabel: document.getElementById('targetLangLabel'),
            speakTarget: document.getElementById('speakTarget'),
            toggleTranslation: document.getElementById('toggleTranslation'),
            recordBtn: document.getElementById('recordBtn'),
            stopBtn: document.getElementById('stopBtn'),
            transcript: document.getElementById('transcript'),
            checkBtn: document.getElementById('checkBtn'),
            recorderStatus: document.getElementById('recorderStatus'),
            correctionBox: document.getElementById('correctionBox'),
            correctionContainer: document.getElementById('correctionContainer'),
            correctionDivider: document.getElementById('correctionDivider'),
            correctCount: document.getElementById('correctCount'),
            totalCount: document.getElementById('totalCount')
        };

        // Langue cible
        const langNames = {
            'el-GR': 'Grec',
            'es-ES': 'Espagnol',
            'de-DE': 'Allemand',
            'it-IT': 'Italien',
            'pt-PT': 'Portugais',
            'ja-JP': 'Japonais'
        };

        // Initialiser Web Speech API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition;
        if (!SpeechRecognition) {
            console.error("Speech Recognition non support√©");
        }

        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = state.targetLang;

            recognition.onstart = () => {
                console.log('üé§ Reconnaissance vocale d√©marr√©e (onstart)');
                state.isRecording = true;
                els.recordBtn.disabled = true;
                els.stopBtn.disabled = false;
                els.recorderStatus.textContent = 'üî¥ Enregistrement en cours...';
                els.recorderStatus.className = 'recorder-status status-recording';
                els.checkBtn.disabled = true;
            };

            recognition.onresult = (event) => {
                state.transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                updateTranscript();
                console.log('R√©sultat:', state.transcript);
            };

            recognition.onerror = (event) => {
                console.error('Erreur reconnaissance:', event.error);
                let errorMsg = event.error;
                if (event.error === 'no-speech') {
                    errorMsg = 'Pas de son d√©tect√©. Parlez plus fort!';
                } else if (event.error === 'network') {
                    errorMsg = 'Erreur r√©seau. V√©rifiez votre connexion.';
                } else if (event.error === 'not-allowed') {
                    errorMsg = 'Acc√®s micro refus√©. V√©rifiez vos param√®tres.';
                } else if (event.error === 'service-not-allowed') {
                    errorMsg = 'Service non autoris√©. (Besoin de HTTPS sur mobile?)';
                }
                els.recorderStatus.textContent = `‚ö†Ô∏è ${errorMsg}`;
                els.recorderStatus.className = 'recorder-status status-error';
                state.isRecording = false;
                els.recordBtn.disabled = false;
                els.stopBtn.disabled = true;
            };

            recognition.onend = () => {
                state.isRecording = false;
                els.recordBtn.disabled = false;
                els.stopBtn.disabled = true;
                els.recorderStatus.textContent = 'Pr√™t √† enregistrer';
                els.recorderStatus.className = 'recorder-status status-ready';
                els.checkBtn.disabled = state.transcript === '';

                // V√©rification automatique
                if (state.transcript !== '') {
                    checkAnswer(true);
                }
            };
        }

        // √âv√©nements
        els.generateBtn.addEventListener('click', generateDialogue);
        els.speakTarget.addEventListener('click', () => {
            speakText(state.currentTarget, state.targetLang);
        });
        els.toggleTranslation.addEventListener('click', toggleTranslation);
        els.recordBtn.addEventListener('click', startRecording);
        els.stopBtn.addEventListener('click', stopRecording);
        els.checkBtn.addEventListener('click', checkAnswer);
        els.topicSelect.addEventListener('change', (e) => {
            state.topic = e.target.value;
            generateDialogue();
        });
        els.targetLangSelect.addEventListener('change', (e) => {
            state.targetLang = e.target.value;
            if (recognition) recognition.lang = state.targetLang;
            els.targetLangLabel.textContent = langNames[state.targetLang];
            generateDialogue();
        });
        els.levelSelect.addEventListener('change', (e) => {
            state.level = e.target.value;
            generateDialogue();
        });

        function autoScroll(el) {
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function generateDialogue() {
            if (state.autoNextTimeout) clearTimeout(state.autoNextTimeout);

            const topicData = DIALOGUES[state.topic] || DIALOGUES['presentation'];
            const levelData = topicData[state.level] || topicData['A1'] || topicData[Object.keys(topicData)[0]];

            const frDialogues = levelData.fr;
            state.currentFrench = frDialogues[Math.floor(Math.random() * frDialogues.length)];
            state.totalCount++;
            els.totalCount.textContent = state.totalCount;

            els.frenchDialogue.textContent = state.currentFrench;
            generateTranslation();

            state.transcript = '';
            els.transcript.innerHTML = '<span class="transcript-empty">Aucun enregistrement</span>';
            els.correctionContainer.style.display = 'none';
            els.correctionDivider.style.display = 'none';
            els.checkBtn.disabled = true;
            els.recordBtn.disabled = false;

            autoScroll(els.frenchDialogue);

            setTimeout(() => {
                speakText(state.currentTarget, state.targetLang);
            }, 1000);
        }

        function generateTranslation() {
            const topicData = DIALOGUES[state.topic] || DIALOGUES['presentation'];
            const levelData = topicData[state.level] || topicData['A1'] || topicData[Object.keys(topicData)[0]];

            const frIndex = levelData.fr.indexOf(state.currentFrench);
            if (frIndex !== -1 && levelData[state.targetLang]) {
                state.currentTarget = levelData[state.targetLang][frIndex];
            } else {
                state.currentTarget = '(Traduction non disponible)';
            }
            els.targetDialogue.textContent = state.showTranslation ? state.currentTarget : '???';
        }

        function startRecording() {
            console.log('Tentative de d√©marrage de l\'enregistrement...');
            if (!recognition) {
                alert("La reconnaissance vocale n'est pas support√©e par ce navigateur ou n√©cessite HTTPS.");
                return;
            }

            if (state.isRecording) return;

            state.transcript = '';
            updateTranscript();
            recognition.lang = state.targetLang;
            try {
                recognition.start();
            } catch (err) {
                console.error("Erreur start recording:", err);
                state.isRecording = false;
                els.recordBtn.disabled = false;
            }
        }

        function stopRecording() {
            if (recognition) recognition.stop();
        }

        function updateTranscript() {
            if (state.transcript) {
                els.transcript.textContent = state.transcript;
            } else {
                els.transcript.innerHTML = '<span class="transcript-empty">Aucun enregistrement</span>';
            }
        }

        function speakText(text, lang) {
            if (!text || text === '???' || text.includes('Traduction non disponible')) return;

            function speak() {
                window.speechSynthesis.cancel();

                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    const voices = window.speechSynthesis.getVoices();
                    const targetLangPrefix = lang.split('-')[0].toLowerCase();
                    let voice = voices.find(v => v.lang === lang) ||
                        voices.find(v => v.lang.toLowerCase().startsWith(targetLangPrefix));

                    if (voice) {
                        utterance.voice = voice;
                        console.log('Voix s√©lectionn√©e:', voice.name, '(', voice.lang, ')');
                    }

                    if (window.speechSynthesis.paused) {
                        window.speechSynthesis.resume();
                    }

                    utterance.lang = lang;
                    utterance.rate = 0.85;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;

                    utterance.onstart = () => {
                        console.log('Lecture commenc√©e pour:', text);
                        els.speakTarget.style.background = 'var(--color-teal-300)';
                        els.speakTarget.textContent = 'üîä Lecture en cours...';
                    };

                    utterance.onend = () => {
                        console.log('Lecture termin√©e.');
                        els.speakTarget.style.background = '';
                        els.speakTarget.textContent = `üîä √âcouter le ${langNames[state.targetLang] || 'Langue'}`;
                    };

                    utterance.onerror = (e) => {
                        console.error('Erreur synth√®se vocale:', e);
                        els.speakTarget.style.background = '';
                        els.speakTarget.textContent = '‚ö†Ô∏è Erreur Audio';
                    };

                    window.speechSynthesis.speak(utterance);
                }, 100);
            }

            if (window.speechSynthesis.getVoices().length > 0) {
                speak();
            } else {
                window.speechSynthesis.onvoiceschanged = () => {
                    speak();
                    window.speechSynthesis.onvoiceschanged = null;
                };
                setTimeout(() => { if (window.speechSynthesis.getVoices().length === 0) speak(); }, 500);
            }
        }

        function toggleTranslation() {
            state.showTranslation = !state.showTranslation;
            els.targetDialogue.textContent = state.showTranslation ? state.currentTarget : '???';
            els.toggleTranslation.textContent = state.showTranslation ? 'üëÅÔ∏è Masquer' : 'üëÅÔ∏è Voir';
        }

        function checkAnswer(isAuto = false) {
            if (!state.transcript) return;
            els.correctionDivider.style.display = 'block';
            els.correctionContainer.style.display = 'block';

            const similarity = calculateSimilarity(state.transcript.toLowerCase(), state.currentTarget.toLowerCase());

            if (similarity > 0.6) {
                els.correctionBox.className = 'correction-box success correction-content';
                els.correctionBox.innerHTML = `<strong>‚úÖ Excellent!</strong> Votre prononciation est tr√®s proche de la cible.`;
                state.correctCount++;
                els.correctCount.textContent = state.correctCount;
            } else {
                els.correctionBox.className = 'correction-box error correction-content';
                els.correctionBox.innerHTML = `<strong>Cible:</strong> ${state.currentTarget}<br><strong>Votre r√©ponse:</strong> ${state.transcript}`;
            }

            autoScroll(els.correctionBox);

            if (isAuto) {
                state.autoNextTimeout = setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    setTimeout(generateDialogue, 500);
                }, 3000);
            }
        }

        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            if (longer.length === 0) return 1.0;
            const editDistance = getEditDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function getEditDistance(s1, s2) {
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        // Initialiser
        els.targetLangLabel.textContent = langNames[state.targetLang];
    </script>
</body>

</html>